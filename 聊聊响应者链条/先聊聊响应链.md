
### å‰è¨€
ä»Šå¤©é¢è¯•æ»´æ»´çš„æ—¶å€™èŠåˆ°äº†[è‡ªå·±ä»¥å‰é‡åˆ°çš„ä¸€ä¸ªå‘](http://)ï¼Œå…¶ä¸­æ¶‰åŠäº†ä¸€äº›å“åº”è€…é“¾æ¡çš„äº‹ã€‚æœ¬èº«è¿™ä¸ªbugå°±å¾ˆæœ‰ä»£è¡¨æ€§(ä»£è¡¨äº†è‡ªå·±å¯¹è¿™å—éå¸¸çš„ä¸ç†Ÿæ‚‰ğŸ˜ƒ)ã€‚æ— ç‹¬æœ‰å¶ï¼Œè‡ªå·±çš„å¥½åŸºå‹å‰å‡ å¤©è…¾è®¯ç”µé¢ä¸€é¢æ—¶ä¹Ÿé‡åˆ°äº†[è¿™ä¸ªé—®é¢˜](http://kyxu.tech/2016/08/19/%E7%88%B6%E8%A7%86%E5%9B%BE%E5%A4%96%E9%83%A8%E5%AD%90%E8%A7%86%E5%9B%BE%E7%82%B9%E5%87%BB%E5%93%8D%E5%BA%94-hitTest/)ã€‚å›æ¥å¥½å¥½çœ‹äº†[å¤§ç¥çš„åšå®¢](http://zhoon.github.io/ios/2015/04/12/ios-event.html)ã€‚å°±é¡ºæ‰‹å†™ä¸ªå­¦ä¹ ç¬”è®°è‡ªæˆ‘æ€»ç»“ä¸‹å§ã€‚

### å…ˆèŠèŠå“åº”é“¾

`UIResponder`æ˜¯æ‰€æœ‰å¯ä»¥å“åº”äº‹ä»¶çš„ç±»çš„åŸºç±»(ä»åå­—åº”è¯¥å°±å¯ä»¥çœ‹å‡ºæ¥äº†)ï¼Œå…¶ä¸­åŒ…æ‹¬æœ€å¸¸è§çš„UIViewå’Œ`UIViewController`ç”šè‡³æ˜¯`UIApplication`ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„`UIView`å’Œ`UIViewController`éƒ½æ˜¯ä½œä¸ºå“åº”äº‹ä»¶çš„è½½ä½“ã€‚

AppleğŸçˆ¸çˆ¸æ˜¯è¿™ä¹ˆè¯´çš„ï¼š
>The UIResponder class defines an interface for objects that respond to and handle events. It is the superclass of UIApplication, UIView and its subclasses (which include UIWindow). Instances of these classes are sometimes referred to as responder objects or, simply, responders.

å…ˆçœ‹çœ‹è¿™ä¸ª`UIResponder`çš„å¤´æ–‡ä»¶ï¼š

```
#import <Foundation/Foundation.h>
#import <UIKit/UIKitDefines.h>
#import <UIKit/UIEvent.h>

NS_ASSUME_NONNULL_BEGIN

@class UIPress;
@class UIPressesEvent;

NS_CLASS_AVAILABLE_IOS(2_0) @interface UIResponder : NSObject

- (nullable UIResponder*)nextResponder;

- (BOOL)canBecomeFirstResponder;    // default is NO
- (BOOL)becomeFirstResponder;

- (BOOL)canResignFirstResponder;    // default is YES
- (BOOL)resignFirstResponder;

- (BOOL)isFirstResponder;
- (void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(nullable UIEvent *)event;
- (void)touchesMoved:(NSSet<UITouch *> *)touches withEvent:(nullable UIEvent *)event;
- (void)touchesEnded:(NSSet<UITouch *> *)touches withEvent:(nullable UIEvent *)event;
- (void)touchesCancelled:(nullable NSSet<UITouch *> *)touches withEvent:(nullable UIEvent *)event;
- (void)touchesEstimatedPropertiesUpdated:(NSSet * _Nonnull)touches NS_AVAILABLE_IOS(9_1);

```

æ³¨ï¼šè¿™é‡Œæˆ‘åˆ é™¤äº†ä¸€äº›æ­¤æ–‡æ— å…³çš„å®šä¹‰

é‚£ä¹ˆ`UIResponder`å’Œæˆ‘ä»¬è®²çš„ç›¸åº”è€…é“¾æ¡åˆ°åº•æ˜¯ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿå…¶å®åœ¨`iOS`ç³»ç»Ÿä¸­ï¼Œæ‰€è°“å“åº”è€…é“¾æ¡å°±æ˜¯ç”±è¿™äº›`UIResponder`é“¾æ¥èµ·æ¥çš„ã€‚ä½ å¯ä»¥æƒ³è±¡æˆé“¾è¡¨ï¼Œé“¾æ¥ä»–ä»¬çš„å°±æ˜¯ä¸Šé¢å®šä¹‰çš„å±æ€§`nextResponder`é“¾æ¥èµ·æ¥çš„ã€‚
![å“åº”è€…é“¾æ¡](/Users/zhengli/Desktop/theResponderLinked/å“åº”è€…é“¾æ¡.)

### `Hit-Testing View`
ç®€å•äº†è§£å“åº”è€…é“¾æ¡æ˜¯ä»€ä¹ˆåï¼Œå°±è¦ä»Šå¤©çš„ä¸»è§’ç™»åœºäº†ï¼š`Hit-Testing View`ã€‚

ä¸ŠèŠ‚æˆ‘ä»¬è®²åˆ°äº†å“åº”è€…é“¾æ¡ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è¯´æ¸…æ¥šå®ƒçš„å·¥ä½œæµç¨‹ã€‚æ¯”å¦‚ä¸Šå›¾ä¸­çš„`intial view`æ˜¯æ€ä¹ˆå¯»æ‰¾åˆ°çš„ï¼Ÿç³»ç»Ÿæ­£æ˜¯é€šè¿‡ä¸€ä¸ªå«åš`Hit-Test`è¿‡ç¨‹æ‰¾åˆ°è¿™ä¸ª`initial obje`çš„ã€‚


`Hit-Test`çš„ç›®çš„å°±æ˜¯å¯»æ‰¾ç›®å‰æ‰‹æŒ‡ç‚¹å‡»åˆ°çš„é‚£ä¸ªæœ€å‰çš„`view`ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸º`responder`ã€‚
è¿™ä¸ªè¿‡ç¨‹å¯¹åº”çš„æ–¹æ³•åœ¨`UIView`é‡Œï¼š

	- (nullable UIView *)hitTest:(CGPoint)point withEvent:(nullable UIEvent *)event;   // recursively calls -pointInside:withEvent:. point is in the receiver's coordinate system
	- (BOOL)pointInside:(CGPoint)point withEvent:(nullable UIEvent *)event;   // default returns YES if point is in bounds
	
å½“ç”¨æˆ·ç‚¹å‡»äº†æ‰‹æœºå±å¹•æ—¶ï¼Œ`UIApplication`å°±ä¼šè°ƒç”¨`UIWindow`çš„`hitTest: withEvent:`æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•æœ€ç»ˆè¿”å›ä¸€ä¸ª`UiView`ã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬è¦æ‰¾åˆ°çš„é‚£ä¸ªæœ€å‰çš„`view`ã€‚é‚£è¿™ä¸ªæ–¹æ³•å…·ä½“æµç¨‹æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿ

æˆ‘ä»¬æ‹¿ä¸‹å›¾è¯´æ˜ä¸‹ï¼š

**UIWindowæœ‰ä¸€ä¸ªMianVIewï¼ŒMainViewé‡Œé¢æœ‰ä¸‰ä¸ªsubViewï¼šview Aã€view Bã€view Cï¼Œä»–ä»¬å„è‡ªæœ‰ä¸¤ä¸ªsubViewï¼Œä»–ä»¬å±‚çº§å…³ç³»æ˜¯ï¼šview Aåœ¨æœ€ä¸‹é¢ï¼Œview Bä¸­é—´ï¼Œview Cæœ€ä¸Š(ä¹Ÿå°±æ˜¯addSubviewçš„é¡ºåºï¼Œè¶Šæ™šaddè¿›å»è¶Šåœ¨ä¸Šé¢)ã€‚**
![å±‚æ¬¡ç»“æ„](/Users/zhengli/Desktop/theResponderLinked/å±‚æ¬¡ç»“æ„.jpg )

**ç°åœ¨å‡è®¾æ‰‹æŒ‡ç‚¹å‡»åœ¨äº†ç»¿è‰²çš„`View B`ä¸Šï¼š**
![image](/Users/zhengli/Desktop/theResponderLinked/æµ‹è¯•å¤šä¸ªview.jpg )

æ­¤æ—¶ï¼Œ`UIApplication`ä¼šè°ƒç”¨`UIWindow`çš„`hitTest:WithEvent:`æ–¹æ³•ï¼Œæ¥ç€`UIWindow`è°ƒç”¨ä¸Šé¢çš„ç¬¬äºŒä¸ªæ–¹æ³•ï¼š`pointInside:withEvent:`ã€‚ç°åœ¨æ‰‹æŒ‡ç‚¹å‡»çš„ä½ç½®æ˜¾ç„¶åœ¨`MainView`çš„`bounds`å†…ï¼Œäºæ˜¯è¿™ä¸ªæ–¹æ³•è¿”å›yesã€‚ç´§æ¥ç€ï¼Œ`MainView`å¼€å§‹éå†`subviews`ã€‚æ­¤å¤„éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šä»indexå€¼è¾ƒå¤§çš„ä½ç½®å¼€å§‹éå†ï¼Œæ¯”å¦‚æ­¤å¤„å°±ä¼šå…ˆæ‰¾åˆ°`VIew C`ä¸Šã€‚å› ä¸ºå®ƒæ˜¯æœ€åä¸€ä¸ªè¢«åŠ å…¥`subviews`æ•°ç»„é‡Œçš„ã€‚åœ¨è°ƒç”¨äº†`pointInside:withEvent:`æ–¹æ³•åï¼Œè¿”å›äº†NOã€‚äºæ˜¯ç»§ç»­åœ¨`MainView`çš„**subview.index - 1**çš„ä½ç½®ç»§ç»­è°ƒç”¨`pointInside:withEvent:`æ–¹æ³•ã€‚å¦‚æ­¤å¾ªç¯ï¼Œæœ€ç»ˆæ‰¾åˆ°æ‰‹æŒ‡æ­¤æ—¶è§¦æ‘¸çš„ä½ç½®:`View B.1`ã€‚

å®Œæ•´æµç¨‹ï¼š
![å®Œæ•´æµç¨‹]( /Users/zhengli/Desktop/theResponderLinked/å®Œæ•´æµç¨‹.jpg)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼šåˆ¤æ–­å½“å‰è¿™ä¸ª`view`æ˜¯ä¸æ˜¯`hitView`æ—¶ï¼Œéœ€è¦åŒæ—¶æ»¡è¶³ä»¥ä¸‹å››ä¸ªæ¡ä»¶ï¼š

	view.userInteractionEnable == YES
	view.hidden == NO
	view.alpha > 0.01f
	[view pointInside:point withEvent:event] == YES

ä»£ç å®ç°èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ğŸ˜„ï¼š

	- (UIView *)hitTest:(CGPoint)point withEvent:(UIEvent *)event{
	    if (self.hidden || self.alpha <= 0.01f || [self pointInside:point withEvent:event] || !self.userInteractionEnabled) {
	        return nil;
	    }
	    for (UIView *subview in [self.subviews reverseObjectEnumerator]) {//æ³¨æ„å€’å™
	     
	        CGPoint newPoint = [subview convertPoint:point fromView:self];
	        UIView *hitView = [subview hitTest:newPoint withEvent:event];
		        
	        if (hitView) {
	            return hitView;
	        }
	    }
	    return self;
	}
	
### `Hit-Testing View`åº”ç”¨

#### æœ€å¸¸ç”¨çš„ï¼šæ‰©å¤§æŒ‰é’®çƒ­åŒº
é¡¹ç›®ä¸­ç»å¸¸æœ‰æ‰©å¤§æŸä¸ªæŒ‰é’®çƒ­åŒºçš„éœ€æ±‚ï¼Œç›¸ä¿¡å®é™…åšè¿‡é¡¹ç›®çš„ç«¥é‹éƒ½æœ‰è¿‡è¿™æ ·çš„ç»å†ã€‚ä»¥å‰å°å¼Ÿçš„åšæ³•æ˜¯æŠŠæŒ‰é’®å®½é«˜è°ƒå¤§ä¸€ç‚¹ï¼Œä½†æ˜¯è¿™æ ·ä¹Ÿä¼šå¯¼è‡´æŒ‰é’®å›¾ç‰‡ä½ç§»ï¼Œè¿˜è¦æ”¹æŒ‰é’®çš„`UIEdgeInsets`ç­‰å±æ€§ï¼Œå¾ˆæ˜¯è›‹ç–¼ã€‚æœ‰äº†`Hit-Testing View`ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿™æ ·å†™ï¼šğŸ˜„

	- (UIView *)hitTest:(CGPoint)point withEvent:(UIEvent *)event{
	    if (self.hidden || self.alpha <= 0.01f  !self.userInteractionEnabled) {
	        return nil;
	    }
	    CGRect newRect ={self.origin,self.width+=10,self.height+=10};
	    if (CGRectContainsPoint(newRect, point)) {
	        return nil;
	    }

	    for (UIView *subview in [self.subviews reverseObjectEnumerator]) {//æ³¨æ„å€’å™
	     
	        CGPoint newPoint = [subview convertPoint:point fromView:self];
	        UIView *hitView = [subview hitTest:newPoint withEvent:event];	        
	        if (hitView) {
	            return hitView;
	        }
	    }
	    return self;
	}


### äº‹ä»¶çš„ä¼ é€’
æœ‰äº†å“åº”è€…é“¾æ¡ï¼Œäº‹ä»¶çš„ä¼ é€’ä¹Ÿå°±æ°´åˆ°æ¸ æˆäº†ã€‚åœ¨`UIApplication`è°ƒç”¨äº†`UIWIndow`çš„`hitTest:withEevent:`æ–¹æ³•å¹¶åæ‚”äº†ä¸€ä¸ª`hitView`åï¼Œå°±ä¼šé€šè¿‡`sendEvent:`è¿™ä¸ªæ–¹æ³•å°†äº‹ä»¶ä¼ é€’ç»™å½“å‰çš„`hitView`ã€‚å¦‚æœå½“å‰çš„`hitView`å¤„ç†ä¸äº†è¯¥äº‹ä»¶ï¼Œå°±ä¼šå°†äº‹ä»¶äº¤ç”±è‡ªå·±çš„`nextResponder`å¤„ç†ï¼Œå¦‚æ­¤é€’å½’ã€‚è‹¥æœ€åäº¤ç”±`UIApplication`ä»ç„¶å¤„ç†ä¸äº†è¯¥äº‹ä»¶ï¼Œç³»ç»Ÿå°±ä¼šæŠ›å¼ƒè¯¥äº‹ä»¶ã€‚


æ‘˜æŠ„ä¸€æ®µå¤§ç¥çš„åšå®¢:
>å¦‚æœ`view`é‡å†™äº†`touch`æ–¹æ³•ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šçœ‹åˆ°çš„æ•ˆæœæ˜¯ï¼Œè¿™ä¸ª`view`å“åº”äº†äº‹ä»¶ä¹‹åï¼Œå®ƒ`nextResponder`ä¸ä¼šæ”¶åˆ°è¿™ä¸ªäº‹ä»¶ï¼Œå³ä½¿é‡å†™äº†`nextResponder`çš„`touch`æ–¹æ³•ã€‚è¿™ä¸ªæ—¶å€™å¦‚æœæƒ³äº‹ä»¶ç»§ç»­ä¼ é€’ä¸‹å»ï¼Œå¯ä»¥è°ƒç”¨`[super touchesBegan:touches withEvent:event]ï¼Œ`ä¸å»ºè®®ç›´æ¥è°ƒç”¨`[self.nextRespondertouchesBegan:touches withEvent:event]`ã€‚

